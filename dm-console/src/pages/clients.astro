---
import Layout from '../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';

const API_URL = import.meta.env.PUBLIC_API_URL || 'https://api.coreon.build';
---

<Layout title="Clients">
  <div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold">클라이언트 관리</h1>
        <p class="text-text-muted mt-1">연결된 클라이언트를 관리하고 업데이트를 배포합니다</p>
      </div>
      <button
        id="registerBtn"
        class="flex items-center gap-2 px-4 py-2 bg-primary hover:bg-primary-dark rounded-lg transition-colors"
      >
        <Icon name="lucide:plus" class="w-5 h-5" />
        <span>클라이언트 등록</span>
      </button>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-bg-card rounded-xl border border-border w-full max-w-md mx-4">
        <div class="p-6 border-b border-border flex items-center justify-between">
          <h2 class="text-xl font-semibold">클라이언트 등록</h2>
          <button id="closeRegisterModal" class="text-text-muted hover:text-text">
            <Icon name="lucide:x" class="w-5 h-5" />
          </button>
        </div>
        <form id="registerForm" class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">클라이언트 이름</label>
            <input
              type="text"
              name="name"
              placeholder="production-server-1"
              required
              class="w-full px-4 py-2 bg-bg rounded-lg border border-border focus:border-primary focus:outline-none"
            />
          </div>
          <div class="flex gap-3 pt-4">
            <button
              type="button"
              id="cancelRegister"
              class="flex-1 px-4 py-2 bg-bg-hover hover:bg-border rounded-lg transition-colors"
            >
              취소
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-primary hover:bg-primary-dark rounded-lg transition-colors"
            >
              등록
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Deploy Modal -->
    <div id="deployModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-bg-card rounded-xl border border-border w-full max-w-md mx-4">
        <div class="p-6 border-b border-border flex items-center justify-between">
          <h2 class="text-xl font-semibold">버전 배포</h2>
          <button id="closeDeployModal" class="text-text-muted hover:text-text">
            <Icon name="lucide:x" class="w-5 h-5" />
          </button>
        </div>
        <form id="deployForm" class="p-6 space-y-4">
          <input type="hidden" name="client_id" id="deployClientId" />
          <div>
            <label class="block text-sm font-medium mb-2">대상 클라이언트</label>
            <p id="deployClientName" class="px-4 py-2 bg-bg rounded-lg border border-border text-text-muted"></p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">배포할 버전</label>
            <select
              name="version"
              id="versionSelect"
              required
              class="w-full px-4 py-2 bg-bg rounded-lg border border-border focus:border-primary focus:outline-none"
            >
              <option value="">버전 선택...</option>
            </select>
          </div>
          <div class="flex gap-3 pt-4">
            <button
              type="button"
              id="cancelDeploy"
              class="flex-1 px-4 py-2 bg-bg-hover hover:bg-border rounded-lg transition-colors"
            >
              취소
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-success hover:bg-success/80 rounded-lg transition-colors flex items-center justify-center gap-2"
            >
              <Icon name="lucide:rocket" class="w-4 h-4" />
              <span>배포</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-bg-card rounded-xl border border-border w-full max-w-md mx-4">
        <div class="p-6 border-b border-border flex items-center justify-between">
          <h2 class="text-xl font-semibold">클라이언트 등록 완료</h2>
          <button id="closeApiKeyModal" class="text-text-muted hover:text-text">
            <Icon name="lucide:x" class="w-5 h-5" />
          </button>
        </div>
        <div class="p-6 space-y-4">
          <div class="bg-warning/10 border border-warning/20 rounded-lg p-4">
            <p class="text-sm text-warning">⚠️ API 키는 한 번만 표시됩니다. 안전한 곳에 저장하세요.</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">API Key</label>
            <div class="flex gap-2">
              <input
                type="text"
                id="apiKeyValue"
                readonly
                class="flex-1 px-4 py-2 bg-bg rounded-lg border border-border font-mono text-sm"
              />
              <button
                id="copyApiKey"
                class="px-4 py-2 bg-primary hover:bg-primary-dark rounded-lg transition-colors"
              >
                복사
              </button>
            </div>
          </div>
          <button
            id="closeApiKeyBtn"
            class="w-full px-4 py-2 bg-bg-hover hover:bg-border rounded-lg transition-colors"
          >
            확인
          </button>
        </div>
      </div>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-bg-card rounded-xl border border-border w-full max-w-lg mx-4">
        <div class="p-6 border-b border-border flex items-center justify-between">
          <h2 class="text-xl font-semibold">클라이언트 설정</h2>
          <button id="closeConfigModal" class="text-text-muted hover:text-text">
            <Icon name="lucide:x" class="w-5 h-5" />
          </button>
        </div>
        <form id="configForm" class="p-6 space-y-4">
          <input type="hidden" name="client_id" id="configClientId" />
          <div>
            <label class="block text-sm font-medium mb-2">서비스 디렉토리</label>
            <input
              type="text"
              name="service_dir"
              id="configServiceDir"
              placeholder="/var/www/my-app"
              class="w-full px-4 py-2 bg-bg rounded-lg border border-border focus:border-primary focus:outline-none font-mono text-sm"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">재시작 명령어</label>
            <input
              type="text"
              name="restart_command"
              id="configRestartCmd"
              placeholder="systemctl restart my-app"
              class="w-full px-4 py-2 bg-bg rounded-lg border border-border focus:border-primary focus:outline-none font-mono text-sm"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">업데이트 전 스크립트</label>
            <input
              type="text"
              name="pre_update_script"
              id="configPreScript"
              placeholder="./backup.sh"
              class="w-full px-4 py-2 bg-bg rounded-lg border border-border focus:border-primary focus:outline-none font-mono text-sm"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">업데이트 후 스크립트</label>
            <input
              type="text"
              name="post_update_script"
              id="configPostScript"
              placeholder="./migrate.sh"
              class="w-full px-4 py-2 bg-bg rounded-lg border border-border focus:border-primary focus:outline-none font-mono text-sm"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Health Check URL</label>
            <input
              type="text"
              name="health_check_url"
              id="configHealthUrl"
              placeholder="http://localhost:3000/health"
              class="w-full px-4 py-2 bg-bg rounded-lg border border-border focus:border-primary focus:outline-none font-mono text-sm"
            />
          </div>
          <div class="flex items-center gap-2">
            <input
              type="checkbox"
              name="rollback_on_failure"
              id="configRollback"
              class="rounded border-border"
            />
            <label for="configRollback" class="text-sm">실패 시 자동 롤백</label>
          </div>
          <div class="flex gap-3 pt-4">
            <button
              type="button"
              id="cancelConfig"
              class="flex-1 px-4 py-2 bg-bg-hover hover:bg-border rounded-lg transition-colors"
            >
              취소
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-primary hover:bg-primary-dark rounded-lg transition-colors"
            >
              저장
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Client List -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="clientGrid">
      <div class="col-span-full text-center text-text-muted py-8">로딩 중...</div>
    </div>
  </div>
</Layout>

<script define:vars={{ API_URL }}>
  // Modal elements
  const registerModal = document.getElementById('registerModal');
  const deployModal = document.getElementById('deployModal');
  const apiKeyModal = document.getElementById('apiKeyModal');
  const configModal = document.getElementById('configModal');
  
  // Register modal
  document.getElementById('registerBtn').addEventListener('click', () => registerModal.classList.remove('hidden'));
  document.getElementById('closeRegisterModal').addEventListener('click', () => registerModal.classList.add('hidden'));
  document.getElementById('cancelRegister').addEventListener('click', () => registerModal.classList.add('hidden'));
  
  // Deploy modal
  document.getElementById('closeDeployModal').addEventListener('click', () => deployModal.classList.add('hidden'));
  document.getElementById('cancelDeploy').addEventListener('click', () => deployModal.classList.add('hidden'));
  
  // API Key modal
  document.getElementById('closeApiKeyModal').addEventListener('click', () => apiKeyModal.classList.add('hidden'));
  document.getElementById('closeApiKeyBtn').addEventListener('click', () => apiKeyModal.classList.add('hidden'));
  document.getElementById('copyApiKey').addEventListener('click', () => {
    const apiKey = document.getElementById('apiKeyValue').value;
    navigator.clipboard.writeText(apiKey);
    document.getElementById('copyApiKey').textContent = '복사됨!';
    setTimeout(() => document.getElementById('copyApiKey').textContent = '복사', 2000);
  });
  
  // Config modal
  document.getElementById('closeConfigModal').addEventListener('click', () => configModal.classList.add('hidden'));
  document.getElementById('cancelConfig').addEventListener('click', () => configModal.classList.add('hidden'));
  
  // Open config modal
  window.openConfig = function(clientId, config) {
    document.getElementById('configClientId').value = clientId;
    document.getElementById('configServiceDir').value = config?.service_dir || '';
    document.getElementById('configRestartCmd').value = config?.restart_command || '';
    document.getElementById('configPreScript').value = config?.pre_update_script || '';
    document.getElementById('configPostScript').value = config?.post_update_script || '';
    document.getElementById('configHealthUrl').value = config?.health_check_url || '';
    document.getElementById('configRollback').checked = config?.rollback_on_failure || false;
    configModal.classList.remove('hidden');
  };
  
  // Config form submit
  document.getElementById('configForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const clientId = document.getElementById('configClientId').value;
    const config = {
      service_dir: document.getElementById('configServiceDir').value || null,
      restart_command: document.getElementById('configRestartCmd').value || null,
      pre_update_script: document.getElementById('configPreScript').value || null,
      post_update_script: document.getElementById('configPostScript').value || null,
      health_check_url: document.getElementById('configHealthUrl').value || null,
      rollback_on_failure: document.getElementById('configRollback').checked,
    };
    
    try {
      const res = await fetch(`${API_URL}/api/clients/${clientId}/config`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ config }),
      });
      
      if (res.ok) {
        configModal.classList.add('hidden');
        fetchClients();
        alert('설정이 저장되었습니다');
      } else {
        alert('저장 실패');
      }
    } catch (error) {
      alert('서버 연결 실패');
    }
  });
  
  // Register form
  document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = e.target.name.value;
    
    try {
      const res = await fetch(`${API_URL}/api/clients`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name }),
      });
      
      if (res.ok) {
        const client = await res.json();
        registerModal.classList.add('hidden');
        e.target.reset();
        
        // Show API key
        document.getElementById('apiKeyValue').value = client.api_key;
        apiKeyModal.classList.remove('hidden');
        
        fetchClients();
      } else {
        alert('등록 실패');
      }
    } catch (error) {
      alert('서버 연결 실패');
    }
  });
  
  // Deploy form
  document.getElementById('deployForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const clientId = document.getElementById('deployClientId').value;
    const version = document.getElementById('versionSelect').value;
    
    try {
      const res = await fetch(`${API_URL}/api/clients/${clientId}/deploy`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client_id: clientId, version }),
      });
      
      if (res.ok) {
        deployModal.classList.add('hidden');
        fetchClients();
      } else {
        alert('배포 실패');
      }
    } catch (error) {
      alert('서버 연결 실패');
    }
  });
  
  // Open deploy modal
  window.openDeploy = async function(clientId, clientName) {
    document.getElementById('deployClientId').value = clientId;
    document.getElementById('deployClientName').textContent = clientName;
    
    // Fetch versions
    try {
      const res = await fetch(`${API_URL}/api/versions`);
      const versions = res.ok ? await res.json() : [];
      const select = document.getElementById('versionSelect');
      select.innerHTML = '<option value="">버전 선택...</option>' +
        versions.map(v => `<option value="${v.version}">v${v.version}</option>`).join('');
    } catch (error) {
      console.error('Failed to fetch versions:', error);
    }
    
    deployModal.classList.remove('hidden');
  };
  
  // Fetch clients
  async function fetchClients() {
    const grid = document.getElementById('clientGrid');
    
    try {
      const res = await fetch(`${API_URL}/api/clients`);
      const clients = res.ok ? await res.json() : [];
      
      if (clients.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center text-text-muted py-8">
            등록된 클라이언트가 없습니다
          </div>
        `;
        return;
      }
      
      grid.innerHTML = clients.map(client => `
        <div class="bg-bg-card rounded-xl border border-border p-6">
          <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-3 h-3 rounded-full ${client.status === 'online' ? 'bg-success' : 'bg-secondary'}"></div>
              <h3 class="font-semibold">${client.name}</h3>
            </div>
            <span class="text-xs px-2 py-1 rounded-full ${client.status === 'online' ? 'bg-success/10 text-success' : 'bg-secondary/10 text-secondary'}">
              ${client.status || 'unknown'}
            </span>
          </div>
          
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-text-muted">현재 버전</span>
              <span class="font-mono">${client.current_version ? 'v' + client.current_version : '-'}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-text-muted">대기 버전</span>
              <span class="font-mono ${client.pending_version ? 'text-warning' : ''}">${client.pending_version ? 'v' + client.pending_version : '-'}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-text-muted">마지막 연결</span>
              <span>${formatDate(client.last_seen)}</span>
            </div>
          </div>
          
          <div class="mt-4 pt-4 border-t border-border flex gap-2">
            <button
              onclick="openDeploy('${client.id}', '${client.name}')"
              class="flex-1 px-3 py-2 bg-primary hover:bg-primary-dark rounded-lg text-sm transition-colors flex items-center justify-center gap-1"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              배포
            </button>
            <button
              onclick='openConfig("${client.id}", ${JSON.stringify(client.config || {})})'
              class="px-3 py-2 bg-secondary/10 hover:bg-secondary/20 text-secondary rounded-lg text-sm transition-colors"
              title="설정"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </button>
            <button
              onclick="deleteClient('${client.id}')"
              class="px-3 py-2 bg-danger/10 hover:bg-danger/20 text-danger rounded-lg text-sm transition-colors"
            >
              삭제
            </button>
          </div>
        </div>
      `).join('');
    } catch (error) {
      grid.innerHTML = `
        <div class="col-span-full text-center text-danger py-8">서버 연결 실패</div>
      `;
    }
  }
  
  window.deleteClient = async function(clientId) {
    if (!confirm('클라이언트를 삭제하시겠습니까?')) return;
    
    try {
      const res = await fetch(`${API_URL}/api/clients/${clientId}`, {
        method: 'DELETE',
      });
      
      if (res.ok) {
        fetchClients();
      } else {
        alert('삭제 실패');
      }
    } catch (error) {
      alert('서버 연결 실패');
    }
  };
  
  function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return '방금 전';
    if (diff < 3600000) return `${Math.floor(diff / 60000)}분 전`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}시간 전`;
    return date.toLocaleDateString('ko-KR');
  }
  
  fetchClients();
</script>
